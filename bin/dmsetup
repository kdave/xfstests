#!/bin/sh

# Stub for dmsetup on systems without udev
# Capture create, resume and remove commands, also needs working udev_wait

op="$1"
name="$2"
verbose=false

_logger() {
	$verbose || return

	if [ -w /dev/kmsg ]; then
		echo "[U] $*" >> /dev/kmsg
		return
	fi
}

# 3 seems to work, try 1
delay=1

_logger "DMSETUP: $@"

# dmsetup mknodes - create the node, or make sure it's deleted

case "$op" in
create)
	/usr/sbin/dmsetup --noudevrules --noudevsync "$@" || return 1
	;;
resume)
	/usr/sbin/dmsetup --noudevrules --noudevsync "$@" || return 1
	;;
remove)
	/usr/sbin/dmsetup --noudevrules --noudevsync "$@" || return 1
	;;
*)
	/usr/sbin/dmsetup "$@"
	;;
esac

sleep $delay
if [ -n "$name" ]; then
	/usr/sbin/dmsetup --noudevrules --noudevsync mknodes "$name" || return 1
fi

# Sync all devices in any case
/usr/sbin/dmsetup --noudevrules --noudevsync mknodes || return 1
_logger "DMSETUP: "$(ls /dev/dm-* /dev/mapper/*)
