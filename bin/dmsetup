#!/bin/sh

# Stub for dmsetup on systems without udev
# Capture create, resume and remove commands, also needs working udev_wait

op="$1"
name="$2"
verbose=false

_logger() {
	$verbose || return

	if [ -w /dev/kmsg ]; then
		echo "[U] $*" >> /dev/kmsg
		return
	fi
}

# 3 seems to work, try 1
delay=1

_logger "DMSETUP: $@"

# dmsetup mknodes - create the node, or make sure it's deleted

case "$op" in
create)
	/usr/sbin/dmsetup --noudevrules --noudevsync "$@" || return 1
	sleep $delay
	/usr/sbin/dmsetup --noudevrules --noudevsync mknodes "$name" || return 1
	_logger "DMSETUP: "$(ls /dev/dm-* /dev/mapper/*)
	;;
resume)
	/usr/sbin/dmsetup --noudevrules --noudevsync "$@" || return 1
	sleep $delay
	/usr/sbin/dmsetup --noudevrules --noudevsync mknodes "$name" || return 1
	_logger "DMSETUP: "$(ls /dev/dm-* /dev/mapper/*)
	;;
remove)
	/usr/sbin/dmsetup --noudevrules --noudevsync "$@" || return 1
	sleep $delay
	/usr/sbin/dmsetup --noudevrules --noudevsync mknodes "$name" || return 1
	_logger "DMSETUP: "$(ls /dev/dm-* /dev/mapper/*)
	;;
*)
	/usr/sbin/dmsetup "$@"
	sleep $delay
	;;
esac
