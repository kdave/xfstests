#! /bin/bash
# SPDX-License-Identifier: GPL-2.0
# Copyright (c) 2025 Chao Yu.  All Rights Reserved.
#
# FS QA Test No. f2fs/019
#
# This is a regression test:
# 1. create a file
# 2. write file to create a direct node at special offset
# 3. use inject.f2fs to inject nid of direct node w/ ino of the inode
# 4. check whether f2fs kernel module will detect and report such
#    corruption in the file
#
. ./common/preamble
_begin_fstest auto quick rw

_fixed_by_kernel_commit 77de19b6867f \
	"f2fs: fix to avoid out-of-boundary access in dnode page"

_require_scratch_nocheck
_require_command "$F2FS_INJECT_PROG" inject.f2fs

# remove all mkfs options to avoid layout change of on-disk inode
export MKFS_OPTIONS=""

testfile=$SCRATCH_MNT/testfile

_scratch_mkfs >> $seqres.full
_scratch_mount

$XFS_IO_PROG -f -c "pwrite 3738M 1M" -c "fsync" $testfile >> $seqres.full

_scratch_unmount

$F2FS_INJECT_PROG --node --mb addr --nid 5 --idx 937 --val 4 $SCRATCH_DEV >> $seqres.full

_scratch_mount
$XFS_IO_PROG -c "pread 3700M 40M" $testfile
_scratch_unmount

status=0
exit
