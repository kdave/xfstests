#! /bin/bash
# SPDX-License-Identifier: GPL-2.0
# Copyright (c) 2025 Chao Yu.  All Rights Reserved.
#
# FS QA Test No. f2fs/020
#
# This is a regression test:
# 1. create directory
# 2. add a new xattr entry to create xattr node
# 3. use inject.f2fs to inject nid of xattr node w/ ino in a file
# 4. check whether f2fs kernel module will detect and report such
#    corruption in the file
#
. ./common/preamble
_begin_fstest auto quick rw

. ./common/attr

_fixed_by_kernel_commit 061cf3a84bde \
	"f2fs: fix to do sanity check on ino and xnid"

_require_scratch_nocheck
_require_inject_f2fs_command node i_xattr_nid
_require_attrs user

# remove all mkfs options to avoid layout change of on-disk inode
export MKFS_OPTIONS=""

testdir=$SCRATCH_MNT/testdir

_scratch_mkfs >> $seqres.full
_scratch_mount "-o user_xattr,noinline_xattr"

mkdir $testdir
# add a new xattr entry to create xattr node
$SETFATTR_PROG -n user.abc -v 123 $testdir

_scratch_unmount

# inject i_xattr_nid w/ nid of inode node
$F2FS_INJECT_PROG --node --mb i_xattr_nid --nid 4 --val 4 $SCRATCH_DEV >> $seqres.full || _fail "failed to inject"

_scratch_mount "-o acl,user_xattr"
# may potentially trigger a deadlock w/ double inode_lock on parent's inode
mkdir $testdir/dir >> $seqres.full 2>&1
_scratch_unmount

echo "Silence is golden"

status=0
exit
